variables:
PYTHON_IMAGE:pipe_image_latest
HELM:/builds/PROD.Platform.HA/Infra.Automation/binary/helm
KUBECTL:/builds/PROD.Platform.HA/Infra.Automation/binary/kubectl
ALPINE_IMAGE:logging_latest
JOB_NAME_CLEAN:''
JOB_NAME_UPDATE:''
#DP_USER:''
#DP_PASS:''
DEPLOY_SCRIPT_APP:/scripts/external_platform_library_builtIn/deploy\_with\_deployer.py
#DEPLOY_SCRIPT_DP:/scripts/external_platform_library_builtIn/deploy_with_helmdeployer.py
UPGRADE_CRD_SCRIPT:/scripts/external_platform_library_builtIn/upgrade_crd.py
APPLY_RESOURCES_SCRIPT:./scripts/prepare_restricted_resources.py
APPLY_API_SERVICE:./scripts/prepare_api_service.py
CLEAN_NS_SCRIPT:/scripts/external_platform_library_builtIn/clean_namespace.py
PATCH_NS_SCRIPT:/scripts/external_platform_library_builtIn/patch_ns_restricted.py
REPORT_SCRIPT:/scripts/external_platform_library_builtIn/report.py
DEPLOY_TIMEOUT:1
###-----------------------------------Cloudspecificconfiguration-----------------------------------###
KUBECONFIG:$QA_KUBER_KUBECONFIG
#KUBECONFIG:$OCP_CERT_1_KUBECONFIG
#KUBECONFIG:$OCP4_AUTO_KUBECONFIG
#KUBECONFIG:$PLATCERT01_KUBECONFIG
###-----------------------------------platcert01configuration---------------------------------------###
#PREFIX:platcert01
#JENKINS_URL:''
#JENKINS_USER:''
#JENKINS_PASS:''
#CREDS_IN_DEPLOYER:''
#RESTRICTED_USER_APP:''
#CLOUD_HOST_OVERALL:${PLATCERT01_HOST}
#CLOUD_TOKEN_OVERALL:${PLATCERT01_TOKEN_ADMIN}
#PROJECT:prometheus-operator
###------------------------------------ocp4_autoconfiguration---------------------------------------###
#PREFIX:ocp4_auto
#JENKINS_URL:''
#JENKINS_USER:''
#JENKINS_PASS:''
#CREDS_IN_DEPLOYER:''
#RESTRICTED_USER_APP:''
#CLOUD_HOST_OVERALL:${OCP4_AUTO_HOST}
#CLOUD_TOKEN_OVERALL:${OCP4_AUTO_TOKEN}
#PROJECT:prometheus-operator
###-----------------------------------ocp_cert_1configuration---------------------------------------###
#PREFIX:ocp_cert_1
#JENKINS_URL:''
#JENKINS_USER:''
#JENKINS_PASS:''
#CREDS_IN_DEPLOYER:''
#RESTRICTED_USER_APP:''
#CLOUD_HOST_OVERALL:${OCP_CERT_1_HOST}
#CLOUD_TOKEN_OVERALL:${OCP_CERT_1_TOKEN}
#PROJECT:prometheus-operator
###-----------------------------------qa_kubernetesconfiguration-----------------------------------###
PREFIX:qa_kubernetes_orchestration
JENKINS_URL:''
JENKINS_USER:''
JENKINS_PASS:''
CREDS_IN_DEPLOYER:''
RESTRICTED_USER_APP:''
CLOUD_HOST_OVERALL:${QA_KUBER_HOST}
CLOUD_TOKEN_OVERALL:${QA_KUBER_TOKEN}
PROJECT:prometheus-operator
###-------------------------------------------Manifests---------------------------------------------###
N2_RELEASE:''
N1_RELEASE:''
PREVIOUS_SPRINT:''
LATEST_SPRINT:''

LATEST_SPRINT_TAG:''
PREVIOUS_SPRINT_TAG:''
N1_RELEASE_TAG:''
N2_RELEASE_TAG:''

#Schemefortesting:cleansandupgradesfromn-1,n-2releases;
N1_RELEASES:"true"
N2_RELEASES:"true"


stages:
-vm_clean_previous_sprint
-vm_upgrade_from_previous_sprint_to_latest_sprint
-vm_clean_latest
-vm_upgrade_latest_diff_params
-vm_clean_release_n1
-vm_update_from_n1_to_latest
-vm_clean_release_n2
-vm_update_from_n2_to_latest
-vm_clean_previous_sprint_restricted
-vm_update_to_latest_restricted
-vm_clean_release_n1_restricted
-vm_update_from_n1_to_latest_restricted
-vm_clean_release_n2_restricted
-vm_update_from_n2_to_latest_restricted
-vm_clean_latest_restricted
-clean_previous_sprint_without_components
-update_to_latest_without_components
-clean_release_n1_without_components
-update_to_latest_from_n1_without_components
-clean_release_n2_without_components
-update_from_n2_to_latest_without_components
-prom_clean_previous_sprint
-prom_update_to_latest
-prom_clean_latest
-update_from_prom_to_vm
-prom_clean_release_n1
-prom_update_from_n1_to_latest
-prom_clean_release_n2
-prom_update_from_n2_to_latest
-prom_clean_previous_sprint_restricted
-prom_update_to_latest_restricted
-prom_clean_release_n1_restricted
-prom_update_from_n1_to_latest_restricted
-prom_clean_release_n2_restricted
-prom_update_from_n2_to_latest_restricted
-prom_clean_latest_restricted
-vm_clean_latest_with_vmauth
-create_report

default:
before_script:
-pipconfigsetglobal.index-urlqubership.org/api/pypi/pypi_python_org.pypi.proxy/simple
-pipconfigsetglobal.trusted-hostdockerhub.qubership.org
-python3-mpipinstall--upgradepip
-pipinstall--no-cache-dir-rrequirements.txt
-exportPYTHONHTTPSVERIFY=0
-apkaddopenssh-client--update-cache--repository${REPOSITORY_URL}--allow-untrusted
-eval$(ssh-agent-s)
-echo"$SSH_PRIVATE_KEY"|ssh-add-
-mkdir-p~/.ssh
-chmod700~/.ssh
-chmod+x$HELM
-chmod+x$KUBECTL
-echo"$KUBECONFIG">kubeconfig.env
-exportKUBECONFIG=/builds/PROD.Platform.HA/Infra.Automation/kubeconfig.env
-echo$PREFIX
-exportDEPLOY_TIMEOUT=$DEPLOY_TIMEOUT

.test-case:&test-case
image:${PYTHON_IMAGE}
extends:.check_state_logs_script.run
variables:
CLOUD_HOST:${CLOUD_HOST_OVERALL}
CLOUD_TOKEN:${CLOUD_TOKEN_OVERALL}
ARRAY_NS:${PROJECT}
ALLOWED_ERROR_LOGS_AMOUNT:1500
tags:
-''
allow_failure:true
when:on_success

include:
-project:'PROD.Platform.HA/Infra.Automation'
ref:pipe_image
file:'api2.yaml'

.run_clean_script:&run_clean_script
-chmod+x./custom_scripts/clean_vm_objects.sh
-./custom_scripts/clean_vm_objects.sh

.run_clean_script2:&run_clean_script2
-python3"$CLEAN_NS_SCRIPT"--cloud-token="${CLOUD_TOKEN}"--cloud-host="${CLOUD_HOST}"--cloud-namespace="${PROJECT}"--cr-list="vmsingles,vmagents,vmalertmanagers,vmalerts,vmauths,vmusers"--group="operator.victoriametrics.com"--version="v1beta1"--api-services="v1beta1.custom.metrics.k8s.io"

.run_label_script:&run_label_script
-python3./scripts/patch_ns.py--cloud-token="${CLOUD_TOKEN}"--cloud-host="${CLOUD_HOST}"--namespace="${PROJECT}"--label="add"

.run_secret_script:&run_secret_script
-python3./scripts/create_etcd_secret.py--cloud-token="${CLOUD_TOKEN}"--cloud-host="${CLOUD_HOST}"--prometheus-namespace="${PROJECT}"

.check_tests_result:&check_tests_result
-python3/scripts/external_platform_library_builtIn/validate_tests_result.py--cloud-host="${CLOUD_HOST}"--cloud-token="${CLOUD_TOKEN}"--namespace="${PROJECT}"--timeout="1800"

#-----VictoriaMetricsWithAllComponents-----#

1-VmClean[PREVIOUS_SPRINT]:
<<:*test-case
stage:vm_clean_previous_sprint
script:
-*run_clean_script
-python-u"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/victoriametrics/vm_with_smoke_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_CLEAN}"--jenkins-url="${JENKINS_URL}"--os-creds="${CREDS_IN_DEPLOYER}"--artifact="${PREVIOUS_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="CleanDeploy"--request-type="post"
-sleep180
-!reference[.template_job_status,script]

2-VmUpgradeFrom[PREVIOUS_SPRINT]To[LATEST_SPRINT]:
<<:*test-case
stage:vm_upgrade_from_previous_sprint_to_latest_sprint
script:
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/victoriametrics/vm_with_full_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_UPDATE}"--jenkins-url="${JENKINS_URL}"--os-creds="${CREDS_IN_DEPLOYER}"--artifact="${LATEST_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="RollingUpdate"--request-type="post"
-*check_tests_result
-!reference[.template_job_status,script]

3-VmClean[LATEST_SPRINT]:
<<:*test-case
stage:vm_clean_latest
script:
-*run_clean_script
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/victoriametrics/vm_with_full_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_CLEAN}"--jenkins-url="${JENKINS_URL}"--os-creds="${CREDS_IN_DEPLOYER}"--artifact="${LATEST_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="CleanDeploy"--request-type="post"
-*check_tests_result
-!reference[.template_job_status,script]

4-VmUpgrade[LATEST_SPRINT]DiffParams:
<<:*test-case
stage:vm_upgrade_latest_diff_params
script:
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/victoriametrics/vm_with_change_params.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_UPDATE}"--jenkins-url="${JENKINS_URL}"--os-creds="${CREDS_IN_DEPLOYER}"--artifact="${LATEST_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="RollingUpdate"--request-type="post"
-*check_tests_result
-!reference[.template_job_status,script]

#ReleasesVictoriaMetrics

5-VmClean[N1_RELEASE]:
<<:*test-case
stage:vm_clean_release_n1
script:
-*run_clean_script
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/victoriametrics/vm_with_smoke_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_CLEAN}"--jenkins-url="${JENKINS_URL}"--os-creds="${CREDS_IN_DEPLOYER}"--artifact="${N1_RELEASE}"--project="${PREFIX}-${PROJECT}"--deploy-mode="CleanDeploy"--request-type="post"
-sleep180
-!reference[.template_job_status,script]
only:{variables:[$N1_RELEASES=="true"]}

6-VmUpgradeFrom[N1_RELEASE]To[LATEST_SPRINT]:
<<:*test-case
stage:vm_update_from_n1_to_latest
script:
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/victoriametrics/vm_with_smoke_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_UPDATE}"--jenkins-url="${JENKINS_URL}"--os-creds="${CREDS_IN_DEPLOYER}"--artifact="${LATEST_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="RollingUpdate"--request-type="post"
-*check_tests_result
-!reference[.template_job_status,script]
only:{variables:[$N1_RELEASES=="true"]}

7-VmClean[N2_RELEASE]:
<<:*test-case
stage:vm_clean_release_n2
script:
-*run_clean_script
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/victoriametrics/vm_with_smoke_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_CLEAN}"--jenkins-url="${JENKINS_URL}"--os-creds="${CREDS_IN_DEPLOYER}"--artifact="${N2_RELEASE}"--project="${PREFIX}-${PROJECT}"--deploy-mode="CleanDeploy"--request-type="post"
-sleep180
-!reference[.template_job_status,script]
only:{variables:[$N2_RELEASES=="true"]}

8-VmUpgradeFrom[N2_RELEASE]To[LATEST_SPRINT]:
<<:*test-case
stage:vm_update_from_n2_to_latest
script:
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/victoriametrics/vm_with_smoke_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_UPDATE}"--jenkins-url="${JENKINS_URL}"--os-creds="${CREDS_IN_DEPLOYER}"--artifact="${LATEST_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="RollingUpdate"--request-type="post"
-*check_tests_result
-!reference[.template_job_status,script]
only:{variables:[$N2_RELEASES=="true"]}

#RestrictedVictoriaMetrics

9-VmClean[PREVIOUS_SPRINT]Restricted:
<<:*test-case
stage:vm_clean_previous_sprint_restricted
script:
-*run_clean_script
-python3"${APPLY_RESOURCES_SCRIPT}"--cloud-host="${CLOUD_HOST}"--cloud-token="${CLOUD_TOKEN}"--namespace="${PROJECT}"--crd-tag="${PREVIOUS_SPRINT_TAG}"
-|-
dir_files=("crds"/*)
if[["${#dir_files[@]}"-gt2]];
then
$KUBECTLreplace-f./crds--allow-missing-template-keys
fi
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/victoriametrics/vm_restricted_with_smoke_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_CLEAN}"--jenkins-url="${JENKINS_URL}"--os-creds="${RESTRICTED_USER_APP}"--artifact="${PREVIOUS_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="CleanDeploy"--request-type="post"
-sleep180
-!reference[.template_job_status,script]

10-VmUpgrade[LATEST_SPRINT]Restricted:
<<:*test-case
stage:vm_update_to_latest_restricted
script:
-python3"${APPLY_RESOURCES_SCRIPT}"--cloud-host="${CLOUD_HOST}"--cloud-token="${CLOUD_TOKEN}"--namespace="${PROJECT}"--crd-tag="${LATEST_SPRINT_TAG}"
-|-
dir_files=("crds"/*)
if[["${#dir_files[@]}"-gt2]];
then
$KUBECTLreplace-f./crds--allow-missing-template-keys
fi
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/victoriametrics/vm_restricted_with_smoke_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_UPDATE}"--jenkins-url="${JENKINS_URL}"--os-creds="${RESTRICTED_USER_APP}"--artifact="${LATEST_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="RollingUpdate"--request-type="post"
-*check_tests_result
-!reference[.template_job_status,script]

11-VmClean[N1_RELEASE]Restricted:
<<:*test-case
stage:vm_clean_release_n1_restricted
script:
-*run_clean_script
-python3"${APPLY_RESOURCES_SCRIPT}"--cloud-host="${CLOUD_HOST}"--cloud-token="${CLOUD_TOKEN}"--namespace="${PROJECT}"--crd-tag="${N1_RELEASE_TAG}"
-|-
dir_files=("crds"/*)
if[["${#dir_files[@]}"-gt2]];
then
$KUBECTLreplace-f./crds--allow-missing-template-keys
fi
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/victoriametrics/vm_restricted_with_smoke_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_CLEAN}"--jenkins-url="${JENKINS_URL}"--os-creds="${RESTRICTED_USER_APP}"--artifact="${N1_RELEASE}"--project="${PREFIX}-${PROJECT}"--deploy-mode="CleanDeploy"--request-type="post"
-sleep180
-!reference[.template_job_status,script]
only:{variables:[$N1_RELEASES=="true"]}

12-VmUpgradeFrom[N1_RELEASE]To[LATEST_SPRINT]Restricted:
<<:*test-case
stage:vm_update_from_n1_to_latest_restricted
script:
-python3"${APPLY_RESOURCES_SCRIPT}"--cloud-host="${CLOUD_HOST}"--cloud-token="${CLOUD_TOKEN}"--namespace="${PROJECT}"--crd-tag="${LATEST_SPRINT_TAG}"
-|-
dir_files=("crds"/*)
if[["${#dir_files[@]}"-gt2]];
then
$KUBECTLreplace-f./crds--allow-missing-template-keys
fi
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/victoriametrics/vm_restricted_with_smoke_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_UPDATE}"--jenkins-url="${JENKINS_URL}"--os-creds="${RESTRICTED_USER_APP}"--artifact="${LATEST_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="RollingUpdate"--request-type="post"
-*check_tests_result
-!reference[.template_job_status,script]
only:{variables:[$N1_RELEASES=="true"]}

13-VmClean[N2_RELEASE]Restricted:
<<:*test-case
stage:vm_clean_release_n2_restricted
script:
-*run_clean_script
-python3"${APPLY_RESOURCES_SCRIPT}"--cloud-host="${CLOUD_HOST}"--cloud-token="${CLOUD_TOKEN}"--namespace="${PROJECT}"--crd-tag="${N2_RELEASE_TAG}"
-|-
dir_files=("crds"/*)
if[["${#dir_files[@]}"-gt2]];
then
$KUBECTLreplace-f./crds--allow-missing-template-keys
fi
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/victoriametrics/vm_restricted_with_smoke_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_CLEAN}"--jenkins-url="${JENKINS_URL}"--os-creds="${RESTRICTED_USER_APP}"--artifact="${N2_RELEASE}"--project="${PREFIX}-${PROJECT}"--deploy-mode="CleanDeploy"--request-type="post"
-sleep180
-!reference[.template_job_status,script]
only:{variables:[$N2_RELEASES=="true"]}

14-VmUpgradeFrom[N2_RELEASE]To[LATEST_SPRINT]Restricted:
<<:*test-case
stage:vm_update_from_n2_to_latest_restricted
script:
-python3"${APPLY_RESOURCES_SCRIPT}"--cloud-host="${CLOUD_HOST}"--cloud-token="${CLOUD_TOKEN}"--namespace="${PROJECT}"--crd-tag="${LATEST_SPRINT_TAG}"
-|-
dir_files=("crds"/*)
if[["${#dir_files[@]}"-gt2]];
then
$KUBECTLreplace-f./crds--allow-missing-template-keys
fi
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/victoriametrics/vm_restricted_with_smoke_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_UPDATE}"--jenkins-url="${JENKINS_URL}"--os-creds="${RESTRICTED_USER_APP}"--artifact="${LATEST_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="RollingUpdate"--request-type="post"
-*check_tests_result
-!reference[.template_job_status,script]
only:{variables:[$N2_RELEASES=="true"]}

15-VmClean[LATEST_SPRINT]Restricted:
<<:*test-case
stage:vm_clean_latest_restricted
script:
-*run_clean_script
-python3"${APPLY_RESOURCES_SCRIPT}"--cloud-host="${CLOUD_HOST}"--cloud-token="${CLOUD_TOKEN}"--namespace="${PROJECT}"--crd-tag="${LATEST_SPRINT_TAG}"
-|-
dir_files=("crds"/*)
if[["${#dir_files[@]}"-gt2]];
then
$KUBECTLreplace-f./crds--allow-missing-template-keys
fi
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/victoriametrics/vm_restricted_with_smoke_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_CLEAN}"--jenkins-url="${JENKINS_URL}"--os-creds="${RESTRICTED_USER_APP}"--artifact="${LATEST_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="CleanDeploy"--request-type="post"
#-python3"${APPLY_API_SERVICE}"--cloud-host="${CLOUD_HOST}"--cloud-token="${CLOUD_TOKEN}"--namespace="${PROJECT}"--crd-tag="${LATEST_SPRINT_TAG}"--api-version="v1beta1.custom.metrics.k8s.io"
-*check_tests_result
-!reference[.template_job_status,script]

#-----NoComponents-----#

16-Clean[PREVIOUS_SPRINT]W/OComponents:
<<:*test-case
stage:clean_previous_sprint_without_components
script:
-*run_clean_script
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/prometheus/no_components.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_CLEAN}"--jenkins-url="${JENKINS_URL}"--os-creds="${CREDS_IN_DEPLOYER}"--artifact="${PREVIOUS_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="CleanDeploy"--request-type="post"
-sleep30
-!reference[.template_job_status,script]

17-UpgradeTo[LATEST_SPRINT]W/OComponents:
<<:*test-case
stage:update_to_latest_without_components
script:
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/prometheus/no_components.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_UPDATE}"--jenkins-url="${JENKINS_URL}"--os-creds="${CREDS_IN_DEPLOYER}"--artifact="${LATEST_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="RollingUpdate"--request-type="post"
-sleep30
-!reference[.template_job_status,script]

18-Clean[N1_RELEASE]W/OComponents:
<<:*test-case
stage:clean_release_n1_without_components
script:
-*run_clean_script
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/prometheus/no_components.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_CLEAN}"--jenkins-url="${JENKINS_URL}"--os-creds="${CREDS_IN_DEPLOYER}"--artifact="${N1_RELEASE}"--project="${PREFIX}-${PROJECT}"--deploy-mode="CleanDeploy"--request-type="post"
-sleep30
-!reference[.template_job_status,script]
only:{variables:[$N1_RELEASES=="true"]}

19-UpgradeFrom[N1_RELEASE]To[LATEST_SPRINT]W/OComponents:
<<:*test-case
stage:update_to_latest_from_n1_without_components
script:
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/prometheus/no_components.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_UPDATE}"--jenkins-url="${JENKINS_URL}"--os-creds="${CREDS_IN_DEPLOYER}"--artifact="${LATEST_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="RollingUpdate"--request-type="post"
-sleep30
-!reference[.template_job_status,script]
only:{variables:[$N1_RELEASES=="true"]}

20-Clean[N2_RELEASE]W/OComponents:
<<:*test-case
stage:clean_release_n2_without_components
script:
-*run_clean_script
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/prometheus/no_components.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_CLEAN}"--jenkins-url="${JENKINS_URL}"--os-creds="${CREDS_IN_DEPLOYER}"--artifact="${N2_RELEASE}"--project="${PREFIX}-${PROJECT}"--deploy-mode="CleanDeploy"--request-type="post"
-sleep30
-!reference[.template_job_status,script]
only:{variables:[$N2_RELEASES=="true"]}

21-UpgradeFrom[N2_RELEASE]To[LATEST_SPRINT]W/OComponents:
<<:*test-case
stage:update_from_n2_to_latest_without_components
script:
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/prometheus/no_components.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_UPDATE}"--jenkins-url="${JENKINS_URL}"--os-creds="${CREDS_IN_DEPLOYER}"--artifact="${LATEST_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="RollingUpdate"--request-type="post"
-sleep30
-!reference[.template_job_status,script]
only:{variables:[$N2_RELEASES=="true"]}

#-----PrometheusWithBasicComponents-----#

22-PromClean[PREVIOUS_SPRINT]:
<<:*test-case
stage:prom_clean_previous_sprint
script:
-*run_clean_script
-*run_label_script
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/prometheus/prom_with_smoke_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_CLEAN}"--jenkins-url="${JENKINS_URL}"--os-creds="${CREDS_IN_DEPLOYER}"--artifact="${PREVIOUS_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="CleanDeploy"--request-type="post"
-sleep180
-!reference[.template_job_status,script]

23-PromUpgradeTo[LATEST_SPRINT]:
<<:*test-case
stage:prom_update_to_latest
script:
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/prometheus/prom_with_full_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_UPDATE}"--jenkins-url="${JENKINS_URL}"--os-creds="${CREDS_IN_DEPLOYER}"--artifact="${LATEST_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="RollingUpdate"--request-type="post"
-*check_tests_result
-!reference[.template_job_status,script]

24-PromClean[LATEST_SPRINT]:
<<:*test-case
stage:prom_clean_latest
script:
-*run_clean_script
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/prometheus/prom_with_full_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_CLEAN}"--jenkins-url="${JENKINS_URL}"--os-creds="${CREDS_IN_DEPLOYER}"--artifact="${LATEST_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="CleanDeploy"--request-type="post"
-*check_tests_result
-!reference[.template_job_status,script]

25-PromUpgradeToVM:
<<:*test-case
stage:update_from_prom_to_vm
script:
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/victoriametrics/vm_with_smoke_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_UPDATE}"--jenkins-url="${JENKINS_URL}"--os-creds="${CREDS_IN_DEPLOYER}"--artifact="${LATEST_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="RollingUpdate"--request-type="post"
-*check_tests_result
-!reference[.template_job_status,script]

#ReleasesPrometheus

26-PromClean[N1_RELEASE]:
<<:*test-case
stage:prom_clean_release_n1
script:
-*run_clean_script
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/prometheus/prom_with_smoke_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_CLEAN}"--jenkins-url="${JENKINS_URL}"--os-creds="${CREDS_IN_DEPLOYER}"--artifact="${N1_RELEASE}"--project="${PREFIX}-${PROJECT}"--deploy-mode="CleanDeploy"--request-type="post"
-sleep180
-!reference[.template_job_status,script]
only:{variables:[$N1_RELEASES=="true"]}

27-PromUpgradeFrom[N1_RELEASE]To[LATEST_SPRINT]:
<<:*test-case
stage:prom_update_from_n1_to_latest
script:
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/prometheus/prom_with_smoke_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_UPDATE}"--jenkins-url="${JENKINS_URL}"--os-creds="${CREDS_IN_DEPLOYER}"--artifact="${LATEST_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="RollingUpdate"--request-type="post"
-*check_tests_result
-!reference[.template_job_status,script]
only:{variables:[$N1_RELEASES=="true"]}

28-PromClean[N2_RELEASE]:
<<:*test-case
stage:prom_clean_release_n2
script:
-*run_clean_script
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/prometheus/prom_with_smoke_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_CLEAN}"--jenkins-url="${JENKINS_URL}"--os-creds="${CREDS_IN_DEPLOYER}"--artifact="${N2_RELEASE}"--project="${PREFIX}-${PROJECT}"--deploy-mode="CleanDeploy"--request-type="post"
-sleep180
-!reference[.template_job_status,script]
only:{variables:[$N2_RELEASES=="true"]}

29-PromUpgradeFrom[N2_RELEASE]To[LATEST_SPRINT]:
<<:*test-case
stage:prom_update_from_n2_to_latest
script:
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/prometheus/prom_with_smoke_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_UPDATE}"--jenkins-url="${JENKINS_URL}"--os-creds="${CREDS_IN_DEPLOYER}"--artifact="${LATEST_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="RollingUpdate"--request-type="post"
-*check_tests_result
-!reference[.template_job_status,script]
only:{variables:[$N2_RELEASES=="true"]}

#RestrictedPrometheus

30-PromClean[PREVIOUS_SPRINT]Restricted:
<<:*test-case
stage:prom_clean_previous_sprint_restricted
script:
-*run_clean_script
-python3"${APPLY_RESOURCES_SCRIPT}"--cloud-host="${CLOUD_HOST}"--cloud-token="${CLOUD_TOKEN}"--namespace="${PROJECT}"--crd-tag="${PREVIOUS_SPRINT_TAG}"
-|-
dir_files=("crds"/*)
if[["${#dir_files[@]}"-gt2]];
then
$KUBECTLreplace-f./crds--allow-missing-template-keys
fi
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/prometheus/prom_restricted_with_smoke_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_CLEAN}"--jenkins-url="${JENKINS_URL}"--os-creds="${RESTRICTED_USER_APP}"--artifact="${PREVIOUS_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="CleanDeploy"--request-type="post"
-python3"${APPLY_API_SERVICE}"--cloud-host="${CLOUD_HOST}"--cloud-token="${CLOUD_TOKEN}"--namespace="${PROJECT}"--crd-tag="${PREVIOUS_SPRINT_TAG}"--api-version="v1beta1.custom.metrics.k8s.io"
-sleep180
-!reference[.template_job_status,script]

31-PromUpgradeTo[LATEST_SPRINT]Restricted:
<<:*test-case
stage:prom_update_to_latest_restricted
script:
-python3"${APPLY_RESOURCES_SCRIPT}"--cloud-host="${CLOUD_HOST}"--cloud-token="${CLOUD_TOKEN}"--namespace="${PROJECT}"--crd-tag="${LATEST_SPRINT_TAG}"
-|-
dir_files=("crds"/*)
if[["${#dir_files[@]}"-gt2]];
then
$KUBECTLreplace-f./crds--allow-missing-template-keys
fi
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/prometheus/prom_restricted_with_smoke_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_UPDATE}"--jenkins-url="${JENKINS_URL}"--os-creds="${RESTRICTED_USER_APP}"--artifact="${LATEST_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="RollingUpdate"--request-type="post"
-*check_tests_result
-!reference[.template_job_status,script]

32-PromClean[N1_RELEASE]Restricted:
<<:*test-case
stage:prom_clean_release_n1_restricted
script:
-*run_clean_script
-python3"${APPLY_RESOURCES_SCRIPT}"--cloud-host="${CLOUD_HOST}"--cloud-token="${CLOUD_TOKEN}"--namespace="${PROJECT}"--crd-tag="${N1_RELEASE_TAG}"
-|-
dir_files=("crds"/*)
if[["${#dir_files[@]}"-gt2]];
then
$KUBECTLreplace-f./crds--allow-missing-template-keys
fi
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/prometheus/prom_restricted_with_smoke_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_CLEAN}"--jenkins-url="${JENKINS_URL}"--os-creds="${RESTRICTED_USER_APP}"--artifact="${N1_RELEASE}"--project="${PREFIX}-${PROJECT}"--deploy-mode="CleanDeploy"--request-type="post"
-python3"${APPLY_API_SERVICE}"--cloud-host="${CLOUD_HOST}"--cloud-token="${CLOUD_TOKEN}"--namespace="${PROJECT}"--crd-tag="${N1_RELEASE_TAG}"--api-version="v1beta1.custom.metrics.k8s.io"
-sleep180
-!reference[.template_job_status,script]
only:{variables:[$N1_RELEASES=="true"]}

33-PromUpgradeFrom[N1_RELEASE]To[LATEST_SPRINT]Restricted:
<<:*test-case
stage:prom_update_from_n1_to_latest_restricted
script:
-python3"${APPLY_RESOURCES_SCRIPT}"--cloud-host="${CLOUD_HOST}"--cloud-token="${CLOUD_TOKEN}"--namespace="${PROJECT}"--crd-tag="${LATEST_SPRINT_TAG}"
-|-
dir_files=("crds"/*)
if[["${#dir_files[@]}"-gt2]];
then
$KUBECTLreplace-f./crds--allow-missing-template-keys
fi
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/prometheus/prom_restricted_with_smoke_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_UPDATE}"--jenkins-url="${JENKINS_URL}"--os-creds="${RESTRICTED_USER_APP}"--artifact="${LATEST_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="RollingUpdate"--request-type="post"
-*check_tests_result
-!reference[.template_job_status,script]
only:{variables:[$N1_RELEASES=="true"]}

34-PromClean[N2_RELEASE]Restricted:
<<:*test-case
stage:prom_clean_release_n2_restricted
script:
-*run_clean_script
-python3"${APPLY_RESOURCES_SCRIPT}"--cloud-host="${CLOUD_HOST}"--cloud-token="${CLOUD_TOKEN}"--namespace="${PROJECT}"--crd-tag="${N2_RELEASE_TAG}"
-|-
dir_files=("crds"/*)
if[["${#dir_files[@]}"-gt2]];
then
$KUBECTLreplace-f./crds--allow-missing-template-keys
fi
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/prometheus/prom_restricted_with_smoke_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_CLEAN}"--jenkins-url="${JENKINS_URL}"--os-creds="${RESTRICTED_USER_APP}"--artifact="${N2_RELEASE}"--project="${PREFIX}-${PROJECT}"--deploy-mode="CleanDeploy"--request-type="post"
-python3"${APPLY_API_SERVICE}"--cloud-host="${CLOUD_HOST}"--cloud-token="${CLOUD_TOKEN}"--namespace="${PROJECT}"--crd-tag="${N2_RELEASE_TAG}"--api-version="v1beta1.custom.metrics.k8s.io"
-sleep180
-!reference[.template_job_status,script]
only:{variables:[$N2_RELEASES=="true"]}

35-PromUpgradeFrom[N2_RELEASE]To[LATEST_SPRINT]Restricted:
<<:*test-case
stage:prom_update_from_n2_to_latest_restricted
script:
-python3"${APPLY_RESOURCES_SCRIPT}"--cloud-host="${CLOUD_HOST}"--cloud-token="${CLOUD_TOKEN}"--namespace="${PROJECT}"--crd-tag="${LATEST_SPRINT_TAG}"
-|-
dir_files=("crds"/*)
if[["${#dir_files[@]}"-gt2]];
then
$KUBECTLreplace-f./crds--allow-missing-template-keys
fi
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/prometheus/prom_restricted_with_smoke_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_UPDATE}"--jenkins-url="${JENKINS_URL}"--os-creds="${RESTRICTED_USER_APP}"--artifact="${LATEST_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="RollingUpdate"--request-type="post"
-*check_tests_result
-!reference[.template_job_status,script]
only:{variables:[$N2_RELEASES=="true"]}

36-PromClean[LATEST_SPRINT]Restricted:
<<:*test-case
stage:prom_clean_latest_restricted
script:
-*run_clean_script
-python3"${APPLY_RESOURCES_SCRIPT}"--cloud-host="${CLOUD_HOST}"--cloud-token="${CLOUD_TOKEN}"--namespace="${PROJECT}"--crd-tag="${LATEST_SPRINT_TAG}"
-|-
dir_files=("crds"/*)
if[["${#dir_files[@]}"-gt2]];
then
$KUBECTLreplace-f./crds--allow-missing-template-keys
fi
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/prometheus/prom_restricted_with_smoke_at.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_CLEAN}"--jenkins-url="${JENKINS_URL}"--os-creds="${RESTRICTED_USER_APP}"--artifact="${LATEST_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="CleanDeploy"--request-type="post"
-python3"${APPLY_API_SERVICE}"--cloud-host="${CLOUD_HOST}"--cloud-token="${CLOUD_TOKEN}"--namespace="${PROJECT}"--crd-tag="${LATEST_SPRINT_TAG}"--api-version="v1beta1.custom.metrics.k8s.io"
-*check_tests_result
-!reference[.template_job_status,script]

37-VmCleanWithVmauth:
<<:*test-case
stage:vm_clean_latest_with_vmauth
script:
-*run_clean_script
-python3"${DEPLOY_SCRIPT_APP}"-f"./templates/${PREFIX}/victoriametrics/vm_with_without_vmauth.yaml"--jenkins-user="${JENKINS_USER}"--jenkins-pass="${JENKINS_PASS}"--job-name="${JOB_NAME_CLEAN}"--jenkins-url="${JENKINS_URL}"--os-creds="${CREDS_IN_DEPLOYER}"--artifact="${LATEST_SPRINT}"--project="${PREFIX}-${PROJECT}"--deploy-mode="CleanDeploy"--request-type="post"
-*check_tests_result
-!reference[.template_job_status,script]

Report:
image:${PYTHON_IMAGE}
tags:
-''
when:on_success
stage:create_report
script:
-python3${REPORT_SCRIPT}--pipeline_id="${CI_PIPELINE_ID}"--token="${GIT_TOKEN}"--webex-room-id="${WEBEX_CI_ROOM_ID}"--webex-token="${WEBEX_CI_TOKEN}"--versions="LATEST_SPRINT=${LATEST_SPRINT},PREVIOUS_SPRINT=${PREVIOUS_SPRINT},N1_RELEASE=${N1_RELEASE},N2_RELEASE=${N2_RELEASE},LATEST_SPRINT_TAG=${LATEST_SPRINT_TAG},PREVIOUS_SPRINT_TAG=${PREVIOUS_SPRINT_TAG},N1_RELEASE_TAG=${N1_RELEASE_TAG},N2_RELEASE_TAG=${N2_RELEASE_TAG}"
artifacts:
paths:
-"*.html"

